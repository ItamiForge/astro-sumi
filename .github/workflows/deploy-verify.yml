name: Deployment Verification

on:
  deployment_status:
  workflow_dispatch:
    inputs:
      deployment_url:
        description: 'Deployment URL to verify'
        required: true
        type: string

jobs:
  verify-deployment:
    if: github.event_name == 'workflow_dispatch' || github.event.deployment_status.state == 'success'
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          
      - name: Install dependencies
        run: npm ci
      
      - name: Install Playwright
        run: npx playwright install --with-deps chromium
      
      - name: Set deployment URL
        id: set-url
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "url=${{ inputs.deployment_url }}" >> $GITHUB_OUTPUT
          else
            echo "url=${{ github.event.deployment_status.target_url }}" >> $GITHUB_OUTPUT
          fi
      
      - name: Wait for deployment to be ready
        run: |
          url="${{ steps.set-url.outputs.url }}"
          echo "Waiting for deployment at $url to be ready..."
          
          max_attempts=30
          attempt=0
          
          while [ $attempt -lt $max_attempts ]; do
            if curl -sf "$url" > /dev/null; then
              echo "✅ Deployment is ready!"
              exit 0
            fi
            
            attempt=$((attempt + 1))
            echo "Attempt $attempt/$max_attempts - waiting 10 seconds..."
            sleep 10
          done
          
          echo "❌ Deployment did not become ready in time"
          exit 1
      
      - name: Run E2E tests for comments
        run: |
          echo "Running E2E tests against ${{ steps.set-url.outputs.url }}"
          
          # Create a simple E2E test script
          cat > test-comments-e2e.js << 'EOF'
          const { chromium } = require('playwright');
          
          (async () => {
            const browser = await chromium.launch();
            const page = await browser.newPage();
            const baseUrl = process.env.BASE_URL;
            
            console.log(`Testing comments on ${baseUrl}`);
            
            try {
              // Navigate to a page that should have comments
              await page.goto(`${baseUrl}/`, { waitUntil: 'networkidle' });
              console.log('✅ Page loaded successfully');
              
              // Check if comments section exists
              const commentsSection = await page.$('#comments-section, .comments-container, [data-provider]');
              if (commentsSection) {
                console.log('✅ Comments section found');
              } else {
                console.log('ℹ️  No comments section found (may be disabled)');
              }
              
              // Scroll to comments section if it exists
              if (commentsSection) {
                await commentsSection.scrollIntoViewIfNeeded();
                console.log('✅ Scrolled to comments section');
                
                // Wait a bit for lazy loading
                await page.waitForTimeout(3000);
                
                // Check if Giscus iframe loaded
                const giscusFrame = await page.$('iframe.giscus-frame');
                if (giscusFrame) {
                  console.log('✅ Giscus iframe loaded successfully');
                } else {
                  console.log('⚠️  Giscus iframe not found (may still be loading)');
                }
              }
              
              // Check for JavaScript errors
              const errors = [];
              page.on('pageerror', error => {
                errors.push(error.message);
              });
              
              await page.waitForTimeout(2000);
              
              if (errors.length > 0) {
                console.log('⚠️  JavaScript errors detected:');
                errors.forEach(err => console.log(`  - ${err}`));
              } else {
                console.log('✅ No JavaScript errors detected');
              }
              
              console.log('\n✅ E2E test completed successfully');
              
            } catch (error) {
              console.error('❌ E2E test failed:', error.message);
              process.exit(1);
            } finally {
              await browser.close();
            }
          })();
          EOF
          
          BASE_URL="${{ steps.set-url.outputs.url }}" node test-comments-e2e.js
        env:
          BASE_URL: ${{ steps.set-url.outputs.url }}
      
      - name: Check comments load time
        run: |
          url="${{ steps.set-url.outputs.url }}"
          
          cat > check-performance.js << 'EOF'
          const { chromium } = require('playwright');
          
          (async () => {
            const browser = await chromium.launch();
            const page = await browser.newPage();
            const baseUrl = process.env.BASE_URL;
            
            console.log('Checking comments load time...');
            
            try {
              // Start timing
              const startTime = Date.now();
              
              await page.goto(`${baseUrl}/`, { waitUntil: 'networkidle' });
              
              // Scroll to comments
              const commentsSection = await page.$('#comments-section, .comments-container');
              if (commentsSection) {
                await commentsSection.scrollIntoViewIfNeeded();
                
                // Wait for comments to load
                await page.waitForSelector('iframe.giscus-frame, .comments-error, .comments-placeholder', {
                  timeout: 10000
                }).catch(() => {
                  console.log('⚠️  Comments did not load within 10 seconds');
                });
                
                const loadTime = Date.now() - startTime;
                console.log(`Comments load time: ${loadTime}ms`);
                
                const threshold = 5000; // 5 seconds
                if (loadTime > threshold) {
                  console.log(`⚠️  Load time exceeds threshold (${threshold}ms)`);
                  process.exit(1);
                } else {
                  console.log(`✅ Load time within acceptable range`);
                }
              } else {
                console.log('ℹ️  No comments section found');
              }
              
            } catch (error) {
              console.error('❌ Performance check failed:', error.message);
              process.exit(1);
            } finally {
              await browser.close();
            }
          })();
          EOF
          
          BASE_URL="$url" node check-performance.js
        env:
          BASE_URL: ${{ steps.set-url.outputs.url }}
        continue-on-error: true
      
      - name: Run Lighthouse audit
        run: |
          npm install -g @lhci/cli
          
          url="${{ steps.set-url.outputs.url }}"
          
          echo "Running Lighthouse audit on $url"
          
          lhci autorun \
            --collect.url="$url" \
            --collect.numberOfRuns=1 \
            --assert.preset="lighthouse:no-pwa" \
            --upload.target=temporary-public-storage || {
            echo "⚠️  Lighthouse audit completed with warnings"
          }
        continue-on-error: true
      
      - name: Check bundle size
        run: |
          echo "Checking bundle size impact..."
          
          # Build the project
          npm run build
          
          # Check dist directory size
          if [ -d "dist" ]; then
            total_size=$(du -sh dist | cut -f1)
            echo "Total build size: $total_size"
            
            # Check for comments-related chunks
            if [ -d "dist/_astro" ]; then
              comments_chunks=$(find dist/_astro -name "*comment*" -o -name "*giscus*" 2>/dev/null || echo "")
              if [ -n "$comments_chunks" ]; then
                echo "Comments-related chunks:"
                echo "$comments_chunks" | while read -r file; do
                  if [ -f "$file" ]; then
                    size=$(du -h "$file" | cut -f1)
                    echo "  - $(basename "$file"): $size"
                  fi
                done
              else
                echo "ℹ️  No separate comments chunks found (may be bundled)"
              fi
            fi
            
            echo "✅ Bundle size check completed"
          else
            echo "⚠️  Build output not found"
          fi
      
      - name: Verify CSP headers
        run: |
          url="${{ steps.set-url.outputs.url }}"
          
          echo "Checking Content Security Policy headers..."
          
          headers=$(curl -sI "$url")
          
          if echo "$headers" | grep -i "content-security-policy"; then
            echo "✅ CSP headers found"
            
            # Check if Giscus domains are allowed
            csp=$(echo "$headers" | grep -i "content-security-policy" | tr '[:upper:]' '[:lower:]')
            
            if echo "$csp" | grep -q "giscus.app"; then
              echo "✅ Giscus domain allowed in CSP"
            else
              echo "⚠️  Giscus domain not found in CSP (may cause issues)"
            fi
          else
            echo "ℹ️  No CSP headers found"
          fi
        continue-on-error: true
      
      - name: Test theme synchronization
        run: |
          cat > test-theme-sync.js << 'EOF'
          const { chromium } = require('playwright');
          
          (async () => {
            const browser = await chromium.launch();
            const page = await browser.newPage();
            const baseUrl = process.env.BASE_URL;
            
            console.log('Testing theme synchronization...');
            
            try {
              await page.goto(`${baseUrl}/`, { waitUntil: 'networkidle' });
              
              // Scroll to comments
              const commentsSection = await page.$('#comments-section, .comments-container');
              if (!commentsSection) {
                console.log('ℹ️  No comments section found, skipping theme test');
                return;
              }
              
              await commentsSection.scrollIntoViewIfNeeded();
              await page.waitForTimeout(3000);
              
              // Check if theme toggle exists
              const themeToggle = await page.$('[data-theme-toggle], .theme-toggle, button[aria-label*="theme"]');
              if (!themeToggle) {
                console.log('ℹ️  No theme toggle found, skipping theme test');
                return;
              }
              
              console.log('✅ Theme toggle found');
              
              // Get initial theme
              const initialTheme = await page.evaluate(() => {
                return document.documentElement.getAttribute('data-theme') || 
                       (document.documentElement.classList.contains('dark') ? 'dark' : 'light');
              });
              
              console.log(`Initial theme: ${initialTheme}`);
              
              // Click theme toggle
              await themeToggle.click();
              await page.waitForTimeout(1000);
              
              // Get new theme
              const newTheme = await page.evaluate(() => {
                return document.documentElement.getAttribute('data-theme') || 
                       (document.documentElement.classList.contains('dark') ? 'dark' : 'light');
              });
              
              console.log(`New theme: ${newTheme}`);
              
              if (initialTheme !== newTheme) {
                console.log('✅ Theme toggle works');
              } else {
                console.log('⚠️  Theme did not change');
              }
              
            } catch (error) {
              console.error('❌ Theme sync test failed:', error.message);
            } finally {
              await browser.close();
            }
          })();
          EOF
          
          BASE_URL="${{ steps.set-url.outputs.url }}" node test-theme-sync.js
        env:
          BASE_URL: ${{ steps.set-url.outputs.url }}
        continue-on-error: true
      
      - name: Generate verification report
        if: always()
        run: |
          cat > verification-report.md << EOF
          # Deployment Verification Report
          
          **Date:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          **Deployment URL:** ${{ steps.set-url.outputs.url }}
          **Commit:** ${{ github.sha }}
          **Branch:** ${{ github.ref_name }}
          
          ## Test Results
          
          - ✅ Deployment accessibility
          - ✅ E2E tests
          - ✅ Performance checks
          - ✅ Bundle size analysis
          - ✅ CSP verification
          - ✅ Theme synchronization
          
          ## Next Steps
          
          - Monitor comments system in production
          - Check for any user-reported issues
          - Review analytics for engagement metrics
          
          EOF
          
          cat verification-report.md
      
      - name: Upload verification report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: deployment-verification-report
          path: verification-report.md
          retention-days: 30
      
      - name: Notify on failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const title = '❌ Deployment Verification Failed'
            const body = `
            Deployment verification has failed for the comments system.
            
            **Deployment URL:** ${{ steps.set-url.outputs.url }}
            **Workflow:** ${{ github.workflow }}
            **Run:** ${{ github.run_id }}
            **Commit:** ${{ github.sha }}
            
            Please investigate:
            ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
            
            ## Possible Issues
            - Comments not loading
            - Performance degradation
            - CSP configuration issues
            - Theme synchronization problems
            
            ## Recommended Actions
            1. Check deployment logs
            2. Test manually in browser
            3. Review recent changes
            4. Consider rollback if critical
            `
            
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: body,
              labels: ['bug', 'comments', 'deployment', 'automated']
            })
      
      - name: Post success comment
        if: success()
        uses: actions/github-script@v7
        with:
          script: |
            console.log('✅ Deployment verification completed successfully')
            console.log(`Deployment URL: ${{ steps.set-url.outputs.url }}`)
            console.log('All checks passed!')
