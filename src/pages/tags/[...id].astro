---
import Breadcrumbs from '@/components/Breadcrumbs.astro'
import { Icon } from '@/components/Icon'
import PageHead from '@/components/PageHead.astro'
import { badgeVariants } from '@/components/ui/badge'
import Layout from '@/layouts/Layout.astro'
import { getAllTags, getNovelsByTag } from '@/lib/content/novels'
import { formatDate } from '@/lib/utils'
import { withBase } from '@/lib/utils/url'
import { Image } from 'astro:assets'

export async function getStaticPaths() {
  const tagMap = await getAllTags()
  const uniqueTags = Array.from(tagMap.keys())

  return Promise.all(
    uniqueTags.map(async (tag) => {
      const novels = await getNovelsByTag(tag)
      return {
        params: { id: tag },
        props: {
          tag,
          novels,
        },
      }
    }),
  )
}

const { tag, novels } = Astro.props
---

<Layout containerType="wide">
  <PageHead
    slot="head"
    title={`Novels tagged with "${tag}"`}
    description={`A collection of novels tagged with ${tag}.`}
    noindex
  />
  <Breadcrumbs
    items={[
      { href: '/tags', label: 'Tags', icon: 'lucide:tags' },
      { label: tag, icon: 'lucide:tag' },
    ]}
  />

  <div class="mb-6">
    <h1 class="mb-2 text-2xl font-bold">Novels tagged with "{tag}"</h1>
    <p class="text-muted-foreground">
      {novels.length} novel{novels.length !== 1 ? 's' : ''} found
    </p>
  </div>

  {
    novels.length > 0 ? (
      <div class="grid gap-6 sm:grid-cols-2 lg:grid-cols-3">
        {novels.map((novel) => (
          <article class="group bg-card text-card-foreground relative overflow-hidden rounded-lg border shadow-sm transition-all hover:shadow-md">
            <a href={withBase(`/novels/${novel.id}`)} class="block">
              {novel.data.coverImage ? (
                <div class="aspect-[3/4] overflow-hidden">
                  <Image
                    src={novel.data.coverImage}
                    alt={novel.data.title}
                    width={300}
                    height={400}
                    class="h-full w-full object-cover transition-transform group-hover:scale-105"
                  />
                </div>
              ) : (
                <div class="bg-muted flex aspect-[3/4] items-center justify-center">
                  <Icon
                    name="book-open"
                    className="text-muted-foreground size-12"
                  />
                </div>
              )}

              <div class="p-4">
                <h2 class="group-hover:text-primary mb-2 line-clamp-2 text-lg font-semibold">
                  {novel.data.title}
                </h2>

                <p class="text-muted-foreground mb-3 line-clamp-3 text-sm">
                  {novel.data.description}
                </p>

                <div class="mb-3 flex flex-wrap gap-1">
                  {novel.data.genre?.slice(0, 2).map((genre) => (
                    <span class={badgeVariants({ variant: 'muted' })}>
                      {genre}
                    </span>
                  ))}
                  {novel.data.genre && novel.data.genre.length > 2 && (
                    <span class={badgeVariants({ variant: 'outline' })}>
                      +{novel.data.genre.length - 2}
                    </span>
                  )}
                </div>

                <div class="text-muted-foreground flex items-center justify-between text-xs">
                  <div class="flex items-center gap-1">
                    <Icon name="calendar" className="size-3" />
                    {formatDate(novel.data.startDate)}
                  </div>

                  <div class="flex items-center gap-1">
                    <Icon
                      name={
                        novel.data.status === 'completed'
                          ? 'lucide:check-circle'
                          : novel.data.status === 'ongoing'
                            ? 'lucide:play-circle'
                            : novel.data.status === 'hiatus'
                              ? 'lucide:pause-circle'
                              : 'lucide:edit'
                      }
                      className="size-3"
                    />
                    <span class="capitalize">{novel.data.status}</span>
                  </div>
                </div>

                {novel.data.wordCount && (
                  <div class="text-muted-foreground mt-2 text-xs">
                    <Icon name="file-text" className="mr-1 inline size-3" />
                    {novel.data.wordCount.toLocaleString()} words
                  </div>
                )}
              </div>
            </a>
          </article>
        ))}
      </div>
    ) : (
      <div class="py-12 text-center">
        <Icon
          name="book-open"
          className="text-muted-foreground mx-auto mb-4 size-16"
        />
        <h2 class="mb-2 text-xl font-semibold">No novels found</h2>
        <p class="text-muted-foreground">No novels are tagged with "{tag}".</p>
      </div>
    )
  }
</Layout>
