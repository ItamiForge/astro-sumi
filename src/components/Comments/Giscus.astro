---
/**
 * Giscus Comments Component
 * GitHub Discussions-powered comments with per-novel/chapter configuration support
 */

import type {
  ChapterCommentConfig,
  GiscusConfig,
  NovelCommentConfig,
} from './types'

// Direct environment variable access - simpler and more predictable
const GISCUS_REPO = import.meta.env.GISCUS_REPO || 'your-username/your-repository'
const GISCUS_REPO_ID = import.meta.env.GISCUS_REPO_ID || 'YOUR_REPO_ID'
const GISCUS_CATEGORY = import.meta.env.GISCUS_CATEGORY || 'General'
const GISCUS_CATEGORY_ID = import.meta.env.GISCUS_CATEGORY_ID || 'YOUR_CATEGORY_ID'
const GISCUS_MAPPING = import.meta.env.GISCUS_MAPPING || 'pathname'
const GISCUS_THEME = import.meta.env.GISCUS_THEME || 'fro'
const GISCUS_LANG = import.meta.env.GISCUS_LANG || 'en'
const GISCUS_REACTIONS_ENABLED = import.meta.env.GISCUS_REACTIONS_ENABLED || '1'
const GISCUS_EMIT_METADATA = import.meta.env.GISCUS_EMIT_METADATA || '0'
const GISCUS_INPUT_POSITION = import.meta.env.GISCUS_INPUT_POSITION || 'top'
const GISCUS_LOADING = import.meta.env.GISCUS_LOADING || 'lazy'
const GISCUS_STRICT = import.meta.env.GISCUS_STRICT || '0'
const GISCUS_ENABLED = import.meta.env.GISCUS_ENABLED === 'true'

export interface Props {
  class?: string
  /** Per-novel comment configuration overrides */
  novelConfig?: NovelCommentConfig
  /** Per-chapter comment configuration overrides */
  chapterConfig?: ChapterCommentConfig
  /** Custom theme override */
  theme?: string
  /** Custom category override */
  category?: string
  /** Custom mapping override */
  mapping?: GiscusConfig['mapping']
  /** Enable theme synchronization with site theme */
  syncTheme?: boolean
  /** Light theme name for theme sync */
  lightTheme?: string
  /** Dark theme name for theme sync */
  darkTheme?: string
}

const {
  class: className = '',
  novelConfig,
  chapterConfig,
  theme: customTheme,
  category: customCategory,
  mapping: customMapping,
  syncTheme = true,
  lightTheme = 'fro',
  darkTheme = 'dark',
} = Astro.props

// Build base configuration from environment variables
const config = {
  repo: GISCUS_REPO,
  repoId: GISCUS_REPO_ID,
  category: GISCUS_CATEGORY,
  categoryId: GISCUS_CATEGORY_ID,
  mapping: GISCUS_MAPPING as GiscusConfig['mapping'],
  theme: GISCUS_THEME,
  lang: GISCUS_LANG,
  reactionsEnabled: GISCUS_REACTIONS_ENABLED as '0' | '1',
  emitMetadata: GISCUS_EMIT_METADATA as '0' | '1',
  inputPosition: GISCUS_INPUT_POSITION as 'top' | 'bottom',
  loading: GISCUS_LOADING as 'lazy' | 'eager',
  strict: GISCUS_STRICT as '0' | '1',
  enabled: GISCUS_ENABLED,
}

// Check if comments are disabled at novel or chapter level
const commentsEnabled =
  novelConfig?.enabled !== false &&
  chapterConfig?.enabled !== false &&
  config.enabled

if (novelConfig) {
  if (novelConfig.customCategory) {
    // Note: In a real implementation, you'd need to map category names to category IDs
    // For now, we'll use the category name as-is
    config.category = novelConfig.customCategory
  }
  if (novelConfig.customTheme) {
    config.theme = novelConfig.customTheme
  }
  if (novelConfig.customMapping) {
    config.mapping = novelConfig.customMapping
  }
}

if (chapterConfig) {
  if (chapterConfig.customCategory) {
    config.category = chapterConfig.customCategory
  }
  if (chapterConfig.customTheme) {
    config.theme = chapterConfig.customTheme
  }
}

// Apply direct prop overrides (highest priority)
if (customTheme) {
  config.theme = customTheme
}
if (customCategory) {
  config.category = customCategory
}
if (customMapping) {
  config.mapping = customMapping
}

// Determine the theme to use
let finalTheme = config.theme
if (
  syncTheme &&
  !customTheme &&
  !novelConfig?.customTheme &&
  !chapterConfig?.customTheme
) {
  // Use theme synchronization - will be handled by client-side script
  finalTheme = 'auto' // Giscus auto theme as fallback
}
---

{
  commentsEnabled ? (
    <div
      class={`giscus-wrapper ${className}`}
      data-sync-theme={syncTheme}
      data-light-theme={lightTheme}
      data-dark-theme={darkTheme}
    >
      <script
        is:inline
        src="https://giscus.app/client.js"
        data-repo={config.repo}
        data-repo-id={config.repoId}
        data-category={config.category}
        data-category-id={config.categoryId}
        data-mapping={config.mapping}
        data-strict={config.strict}
        data-reactions-enabled={config.reactionsEnabled}
        data-emit-metadata={config.emitMetadata}
        data-input-position={config.inputPosition}
        data-theme={finalTheme}
        data-lang={config.lang}
        data-loading={config.loading}
        crossorigin="anonymous"
        async
      />
    </div>
  ) : (
    <div class={`comments-disabled ${className}`}>
      <p class="text-muted-foreground py-4 text-center text-sm">
        Comments are disabled for this content.
      </p>
    </div>
  )
}

<script>
  function initGiscusThemeSync() {
    const giscusWrappers = document.querySelectorAll(
      '.giscus-wrapper[data-sync-theme="true"]',
    )

    giscusWrappers.forEach((wrapper) => {
      const lightTheme = wrapper.getAttribute('data-light-theme') || 'fro'
      const darkTheme = wrapper.getAttribute('data-dark-theme') || 'dark'

      function updateGiscusTheme() {
        const currentTheme = document.documentElement.getAttribute('data-theme')
        const giscusTheme = currentTheme === 'dark' ? darkTheme : lightTheme

        const giscusFrame = wrapper.querySelector(
          'iframe.giscus-frame',
        ) as HTMLIFrameElement
        if (giscusFrame) {
          const message = {
            type: 'set-theme',
            theme: giscusTheme,
          }
          giscusFrame.contentWindow?.postMessage(
            { giscus: message },
            'https://giscus.app',
          )
        }
      }

      // Update theme when Giscus loads
      const observer = new MutationObserver((mutations) => {
        mutations.forEach((mutation) => {
          if (mutation.type === 'childList') {
            const giscusFrame = wrapper.querySelector('iframe.giscus-frame')
            if (giscusFrame) {
              // Wait a bit for Giscus to fully load
              setTimeout(updateGiscusTheme, 1000)
              observer.disconnect()
            }
          }
        })
      })

      observer.observe(wrapper, { childList: true, subtree: true })

      // Listen for theme changes
      const themeObserver = new MutationObserver((mutations) => {
        mutations.forEach((mutation) => {
          if (
            mutation.type === 'attributes' &&
            mutation.attributeName === 'data-theme'
          ) {
            updateGiscusTheme()
          }
        })
      })

      themeObserver.observe(document.documentElement, { attributes: true })
    })
  }

  // Initialize on page load
  initGiscusThemeSync()

  // Re-initialize after page transitions
  document.addEventListener('astro:after-swap', initGiscusThemeSync)
</script>

<style>
  .giscus-wrapper {
    width: 100%;
    margin-top: 2rem;
  }

  .comments-disabled {
    width: 100%;
    margin-top: 2rem;
    padding: 1rem;
    border: 1px solid hsl(var(--border));
    border-radius: 0.5rem;
    background-color: hsl(var(--muted));
  }
</style>
